<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokemon æ™‚é–“é­”æ•¸å¤§å°æ±º</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        :root {
            --primary-color: #4facfe; --secondary-color: #00f2fe;
            --danger-color: #ff0844; --success-color: #43e97b;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        * { box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; font-family: 'Noto Sans TC', sans-serif; }

        body {
            margin: 0; padding: 0;
            background: linear-gradient(-45deg, #1a2a6c, #b21f1f, #fdbb2d); background-size: 400% 400%;
            animation: gradientBG 15s ease infinite; min-height: 100vh;
            display: flex; justify-content: center; color: white;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        #app-container {
            width: 100%; max-width: 600px; display: flex; flex-direction: column; position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.8); background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px);
            overflow: hidden; min-height: 100vh;
        }

        /* --- ä¸»é é¢ (Home Screen) --- */
        #home-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; padding: 30px; text-align: center; flex: 1; z-index: 10;
        }
        .game-title { font-size: 38px; font-weight: 900; text-shadow: 0 0 20px rgba(255,255,255,0.8); margin-bottom: 25px; line-height: 1.2;}
        
        .instructions {
            background: rgba(0,0,0,0.6); border: 1px solid var(--glass-border); border-radius: 15px;
            padding: 20px; text-align: left; margin-bottom: 40px; box-shadow: var(--glass-shadow);
            width: 100%; max-width: 400px; line-height: 1.8; font-size: 16px;
        }
        .instructions h3 { margin-top: 0; color: #43e97b; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;}
        
        .start-btn {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border: none; border-radius: 30px; font-size: 24px; font-weight: 900; color: #d35400;
            padding: 15px 50px; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: all 0.2s;
        }
        .start-btn:active { transform: scale(0.95); box-shadow: 0 5px 10px rgba(0,0,0,0.3); }

        /* ä¸»é åº•éƒ¨ç‰ˆæ¬Šèˆ‡è£½ä½œè€… */
        .bottom-info { position: absolute; bottom: 15px; width: 90%; text-align: center; display: flex; flex-direction: column; gap: 8px; }
        .author-text-bottom { font-size: 14px; font-weight: bold; color: #f1c40f; letter-spacing: 1px; } 
        .copyright-notice { font-size: 10px; color: rgba(255,255,255,0.4); line-height: 1.4; }

        /* --- éŠæˆ² UI å€ --- */
        #game-ui { display: none; flex-direction: column; height: 100%; flex: 1; }

        #top-bar {
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            background: var(--glass-bg); border-bottom: 1px solid var(--glass-border); box-shadow: var(--glass-shadow);
        }
        .tag-container { display: flex; gap: 10px; }
        .tag { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-weight: 700; border: 1px solid rgba(255,255,255,0.4); }
        .pause-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white; border: none; padding: 6px 15px; border-radius: 20px;
            font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s; font-size: 14px;
        }
        .pause-btn:active { transform: scale(0.95); }

        #battle-stage {
            flex: 1; position: relative; padding: 30px 15px; display: flex; flex-direction: column;
            justify-content: space-between; overflow: hidden; background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .combatant-row { display: flex; align-items: center; justify-content: center; gap: 15px; position: relative; z-index: 2; }

        .status-card {
            background: var(--glass-bg); backdrop-filter: blur(8px); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 15px; width: 180px; box-shadow: var(--glass-shadow);
        }
        .name-display { font-size: 18px; font-weight: 900; margin-bottom: 8px; text-shadow: 1px 1px 2px #000; }
        .hp-track { width: 100%; height: 12px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        .hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); transition: width 0.5s ease; }
        .energy-box { display: flex; gap: 8px; margin-top: 10px; }
        .energy-ball { width: 18px; height: 18px; border-radius: 50%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; }
        .energy-ball.active { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); box-shadow: 0 0 10px #f6d365, inset 0 0 5px white; border: none; }
        .lives-display { font-size: 14px; margin-top: 8px; font-weight: bold; }

        .sprite-container { position: relative; width: 160px; height: 160px; display: flex; justify-content: center; align-items: flex-end; }
        .platform { position: absolute; bottom: 0; width: 130px; height: 35px; background: radial-gradient(ellipse at center, rgba(0,0,0,0.6) 0%, transparent 70%); }
        .sprite { width: 150px; height: 150px; object-fit: contain; position: relative; z-index: 2; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); animation: float 3s ease-in-out infinite; }
        #player-sprite { transform: scaleX(-1); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        #control-panel { background: var(--glass-bg); border-top: 1px solid var(--glass-border); padding: 20px; backdrop-filter: blur(15px); }
        #message-display {
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 15px;
            font-size: 16px; font-weight: bold; min-height: 70px; display: flex; align-items: center; margin-bottom: 20px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 10px; }
        .action-btn {
            border: none; border-radius: 15px; font-size: 18px; font-weight: 900; padding: 15px 5px; cursor: pointer; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 6px 0 rgba(0,0,0,0.4), 0 10px 20px rgba(0,0,0,0.3); transition: all 0.1s;
        }
        .action-btn:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0.4); }
        .action-btn span { font-size: 12px; margin-top: 8px; font-weight: 400; opacity: 0.9; }
        .action-btn:disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-charge { background: linear-gradient(to bottom, #f39c12, #e67e22); }
        .btn-attack { background: linear-gradient(to bottom, #e74c3c, #c0392b); }
        .btn-heal   { background: linear-gradient(to bottom, #2ecc71, #27ae60); }
        .footer { text-align: center; font-size: 14px; font-weight: bold; color: rgba(255,255,255,0.8); margin-top: 15px;}

        /* --- æ•¸å­¸é¡Œ Overlay --- */
        #math-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 15, 30, 0.95); backdrop-filter: blur(15px);
            z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .math-timer-box {
            width: 90%; max-width: 400px; height: 15px; border-radius: 10px; margin-bottom: 30px;
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3); box-shadow: inset 0 2px 5px rgba(0,0,0,0.8); overflow: hidden;
        }
        .math-timer-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #43e97b 0%, #f6d365 50%, #ff0844 100%); transition: width 0.1s linear; }
        .math-question { font-size: 34px; color: #fff; font-weight: 900; margin-bottom: 25px; text-align: center; line-height: 1.3;}
        
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 5px; font-size: 1em; }
        .frac-num { border-bottom: 3px solid white; padding: 0 5px; }
        .frac-den { padding: 0 5px; }

        .math-input {
            font-size: 36px; font-weight: bold; width: 240px; height: 70px; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.4); border: 2px solid var(--secondary-color); border-radius: 15px; color: #00f2fe; margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.3);
        }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; max-width: 350px; }
        .num-key {
            padding: 15px 0; font-size: 26px; font-weight: bold; border-radius: 12px; cursor: pointer; color: white;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.1s;
        }
        .num-key:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        .key-clear { background: rgba(255, 8, 68, 0.3); color: #ffb199; }
        .key-ok { background: rgba(67, 233, 123, 0.3); color: #43e97b; grid-column: span 3; font-size: 22px;}

        .mcq-container { display: none; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .mcq-btn {
            padding: 20px 10px; font-size: 26px; font-weight: bold; border-radius: 15px; cursor: pointer; color: white;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 8px 32px rgba(0,0,0,0.3); transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; min-height: 80px; flex-direction: column;
        }
        .mcq-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }

        /* --- é·¹æ¶ Modal --- */
        #scaffold-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px);
            z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .scaffold-card { background: rgba(20, 30, 60, 0.95); border: 2px solid #00f2fe; border-radius: 20px; padding: 25px; max-width: 450px; width: 100%; box-shadow: 0 0 40px rgba(0, 242, 254, 0.4); }
        .scaffold-title { color: #f6d365; font-size: 22px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; }
        .scaffold-content { font-size: 18px; line-height: 1.7; margin-bottom: 25px; color: #fff; }
        .scaffold-content .highlight { color: #43e97b; font-weight: bold; font-size: 1.2em;}
        .btn-understand { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; border-radius: 12px; cursor: pointer; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; box-shadow: 0 5px 15px rgba(0,242,254,0.4); }

        /* --- æš«åœç•«é¢ Modal --- */
        #pause-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
            z-index: 10001; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }

        /* --- ç²¾ç¾çµç®—ç•«é¢ Modal --- */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px);
            z-index: 10002; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;
        }
        .result-card {
            background: rgba(20, 30, 60, 0.95); border: 2px solid var(--secondary-color); border-radius: 20px;
            padding: 30px; max-width: 500px; width: 100%; box-shadow: 0 0 40px rgba(0, 242, 254, 0.4);
            display: flex; flex-direction: column; align-items: center;
        }
        .result-title { font-size: 32px; font-weight: 900; margin-bottom: 20px; text-shadow: 0 0 15px rgba(255,255,255,0.8); }
        .result-stats { font-size: 18px; line-height: 1.8; color: #ddd; width: 100%; text-align: left; margin-bottom: 20px; font-weight: bold;}
        .result-stats input { 
            font-size: 18px; padding: 8px 12px; border-radius: 8px; border: 2px solid #4facfe; 
            outline: none; width: 180px; background: rgba(255,255,255,0.9); font-family: inherit; font-weight: bold;
        }
        .result-gallery { 
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 25px; 
            background: rgba(0,0,0,0.5); padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); width: 100%;
        }
        .result-gallery img { width: 65px; height: 65px; object-fit: contain; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.6)); }

        /* å‹•ç•«ç‰¹æ•ˆ */
        @keyframes shake { 0%, 100% { transform: translate(0, 0); filter: brightness(1); } 20%, 60% { transform: translate(-10px, 0); filter: brightness(1.5) sepia(1) hue-rotate(-50deg); } 40%, 80% { transform: translate(10px, 0); } }
        .shake-anim { animation: shake 0.5s; }
        @keyframes healGlow { 50% { filter: brightness(1.5) drop-shadow(0 0 30px #43e97b); } }
        .heal-anim { animation: healGlow 0.8s ease-in-out; }

        /* æ¸¬è©¦ç”¨ä½œå¼ŠæŒ‰éˆ• */
        .dev-skip-btn { position: absolute; top: 10px; left: 10px; background: #e74c3c; color: white; border: 2px solid white; padding: 5px 10px; border-radius: 5px; cursor: pointer; z-index: 10005; font-size: 12px;}
    </style>
</head>
<body>

<!-- æ¸¬è©¦ç”¨æŒ‰éˆ• (æ­£å¼ç‰ˆå¯åˆªé™¤æ­¤è¡Œ) -->
button class="dev-skip-btn" onclick="skipToBoss()">ğŸ›  è·³è‡³æœ€å¾Œä¸€é—œ</button

<div id="app-container">

    <!-- ä¸»é é¢ -->
    <div id="home-screen">
        <div class="game-title">Pokemon<br>æ™‚é–“é­”æ•¸å¤§å°æ±º</div>
        
        <div class="instructions">
            <h3>ğŸ“– éŠæˆ²ç©æ³•</h3>
            1. æˆ°é¬¥ä¸­é¸æ“‡ã€Œå„²èƒ½ã€ã€ã€Œé€²æ”»ã€æˆ–ã€Œå›å¾©ã€ã€‚<br>
            2. é€²æ”»éœ€æ¶ˆè€—1é»èƒ½é‡ï¼Œè«‹å‹™å¿…å…ˆå„²èƒ½ã€‚<br>
            3. åœ¨æ™‚é–“å…§æ­£ç¢ºå›ç­”æ™‚é–“èˆ‡åˆ†æ•¸/å°æ•¸çš„è½‰æ›ã€‚<br>
            4. <span style="color:#f6d365; font-weight:bold;">ç­”é¡Œè¶Šå¿«ï¼Œæ¯”å¡è¶…çš„æ”»æ“ŠåŠ›è¶Šé«˜ï¼</span><br>
            5. è¿æˆ°å‚³èªªå¯¶å¯å¤¢ï¼Œæˆç‚ºæ™‚é–“é­”æ•¸å¤§å¸«ï¼
        </div>

        <button class="start-btn" onclick="startGame()">â–¶ é–‹å§‹æˆ°é¬¥</button>
        
        <div class="bottom-info">
            <div class="author-text-bottom">è£½ä½œè€…ï¼šé™³æ²…æ˜Šè€å¸«</div>
            <div class="copyright-notice">
                æœ¬æ•™å­¸ææ–™ä¸­æ‰€ä½¿ç”¨ä¹‹åœ–ç‰‡ç‰ˆæ¬Šæ­¸Â© PokÃ©mon / Nintendo / Creatures / GAME FREAK æ‰€æœ‰ã€‚åƒ…ä¾›æ•™è‚²ç”¨é€”ã€‚
            </div>
        </div>
    </div>

    <!-- éŠæˆ² UI å€ -->
    <div id="game-ui">
        <div id="top-bar">
            <div class="tag-container">
                <div class="tag">é—œå¡ <span id="level-id">1</span></div>
                <div class="tag" style="background: rgba(0,0,0,0.3);">â±ï¸ <span id="game-time">00:00</span></div>
            </div>
            <button class="pause-btn" onclick="togglePause()">â¸ æš«åœ</button>
        </div>

        <div id="battle-stage">
            <div class="combatant-row" id="enemy-row">
                <div class="status-card">
                    <div class="name-display" id="enemy-name">å°æ‰‹</div>
                    <div style="font-size:12px; margin-bottom:5px; color: #ddd;">HP</div>
                    <div class="hp-track"><div class="hp-bar" id="enemy-hp-bar"></div></div>
                </div>
                <div class="sprite-container"><div class="platform"></div><img id="enemy-img" class="sprite" src="" alt="Enemy"></div>
            </div>
            <div class="combatant-row" id="player-row">
                <!-- æˆ°é¬¥ä¸­æ¢å¾©ç‚ºç¶“å…¸èƒŒå½±å‹•åœ– -->
                <div class="sprite-container"><div class="platform"></div><img id="player-img" class="sprite" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/back/25.gif" alt="Player"></div>
                <div class="status-card">
                    <div class="name-display">æ¯”å¡è¶…</div>
                    <div class="hp-track"><div class="hp-bar" id="player-hp-bar"></div></div>
                    <div class="lives-display">ç”Ÿå‘½: <span id="player-lives">â¤ï¸â¤ï¸â¤ï¸</span></div>
                    <div class="energy-box"><div class="energy-ball" id="eb-1"></div><div class="energy-ball" id="eb-2"></div><div class="energy-ball" id="eb-3"></div></div>
                </div>
            </div>
        </div>

        <div id="control-panel">
            <div id="message-display">æº–å‚™è¿æˆ°ï¼è«‹é‹ç”¨æ™‚é–“é­”æ•¸æ“Šæ•—å°æ‰‹ï¼</div>
            <div class="btn-group">
                <button class="action-btn btn-charge" id="btn-charge" onclick="startTurn('charge')">âš¡ å„²èƒ½<span>(å¿…éœ€)</span></button>
                <button class="action-btn btn-attack" id="btn-attack" onclick="startTurn('attack')" disabled>âš”ï¸ é€²æ”»<span>(è€—1èƒ½)</span></button>
                <button class="action-btn btn-heal" id="btn-heal" onclick="startTurn('heal')">ğŸ’š å›å¾©<span>(å›è¡€)</span></button>
            </div>
            <div class="footer">ç­”é¡Œè¶Šå¿«ï¼Œæ¯”å¡è¶…çš„æ”»æ“ŠåŠ›è¶Šé«˜å–”ï¼</div>
        </div>
    </div>

    <!-- æ•¸å­¸é¡Œ Overlay -->
    <div id="math-overlay">
        <div class="math-timer-box"><div class="math-timer-bar" id="q-timer-bar"></div></div>
        <div class="math-question" id="q-text"></div>
        
        <div class="math-input" id="q-input-box"><span id="q-input"></span><span id="q-unit" style="font-size:20px; margin-left:10px;"></span></div>
        <div class="numpad" id="numpad-area">
            <button class="num-key" onclick="pressKey('1')">1</button><button class="num-key" onclick="pressKey('2')">2</button><button class="num-key" onclick="pressKey('3')">3</button>
            <button class="num-key" onclick="pressKey('4')">4</button><button class="num-key" onclick="pressKey('5')">5</button><button class="num-key" onclick="pressKey('6')">6</button>
            <button class="num-key" onclick="pressKey('7')">7</button><button class="num-key" onclick="pressKey('8')">8</button><button class="num-key" onclick="pressKey('9')">9</button>
            <button class="num-key key-clear" onclick="pressClear()">C</button><button class="num-key" onclick="pressKey('0')">0</button><button class="num-key" onclick="pressKey('.')">.</button>
            <button class="num-key key-ok" onclick="pressOk()">ç¢ºèªç­”æ¡ˆ (OK)</button>
        </div>

        <div class="mcq-container" id="mcq-area">
            <button class="mcq-btn" onclick="checkMcq(0)" id="mcq-0"></button><button class="mcq-btn" onclick="checkMcq(1)" id="mcq-1"></button>
            <button class="mcq-btn" onclick="checkMcq(2)" id="mcq-2"></button><button class="mcq-btn" onclick="checkMcq(3)" id="mcq-3"></button>
        </div>
    </div>

    <!-- AI é·¹æ¶ Modal -->
    <div id="scaffold-overlay">
        <div class="scaffold-card">
            <div class="scaffold-title">ğŸ’¡ æ´›æ‰˜å§†åœ–é‘‘ï¼šè¨“ç·´å¸«æé†’ï¼</div>
            <div class="scaffold-content" id="scaffold-text">é€™è£¡æ”¾è§£é¡Œæç¤º</div>
            <button class="btn-understand" onclick="closeScaffoldAndContinue()">æˆ‘æ˜ç™½äº†ï¼ç¹¼çºŒæˆ°é¬¥</button>
        </div>
    </div>

    <!-- æš«åœç•«é¢ Modal -->
    <div id="pause-screen">
        <h1 style="font-size: 40px; text-shadow: 0 0 20px #fff; margin-bottom: 30px;">éŠæˆ²æš«åœ â¸</h1>
        <button class="mcq-btn" style="width: 250px; min-height: 60px; margin-bottom: 15px;" onclick="togglePause()">ç¹¼çºŒéŠæˆ²</button>
        <button class="start-btn" style="width: 250px; font-size: 20px;" onclick="returnToHome()">è¿”å›ä¸»é </button>
    </div>

    <!-- ç²¾ç¾çµç®—ç•«é¢ Modal -->
    <div id="result-overlay">
        <div class="result-card">
            <div class="result-title" id="result-title">éŠæˆ²çµæŸ</div>
            
            <div class="result-stats">
                <div style="margin-bottom:10px;">ğŸ‘¤ è¨“ç·´å¸«ï¼š<input type="text" id="player-name-input" placeholder="è¼¸å…¥ä½ çš„åå­—..." autocomplete="off"></div>
                <div>â±ï¸ ç¸½è€—æ™‚ï¼š<span id="res-time" style="color:#f6d365;"></span></div>
                <div>â¤ï¸ å‰©é¤˜å‘½ï¼š<span id="res-lives"></span></div>
                <div>ğŸ¯ ç­”å°ç‡ï¼š<span id="res-accuracy" style="color:#43e97b;"></span></div>
            </div>

            <div style="font-size: 14px; color: #aaa; margin-bottom: 5px; width:100%; text-align:left;">ğŸ† æˆ°åˆ©å“ï¼š</div>
            <div class="result-gallery" id="res-gallery">
                <!-- é€™è£¡å°‡ç”± JS å‹•æ…‹ç”Ÿæˆè¢«æ‰“æ•—çš„å¯¶å¯å¤¢åœ– (å®˜æ–¹ç«‹ç¹ª) -->
            </div>

            <button class="start-btn" style="font-size: 18px; padding: 12px 30px;" onclick="returnToHome()">é‡æ–°æŒ‘æˆ° / è¿”å›ä¸»é </button>
        </div>
    </div>

</div>

<script>
    /* --- é—œå¡é…ç½®ï¼šåŠ å…¥é›™è»Œç´ æç³»çµ± (imgAnim ç”¨æ–¼æˆ°é¬¥, imgArt ç”¨æ–¼çµç®—) --- */
    const LEVELS =[
        { id: 1, type: "frac_to_min", name: "ä¼Šå¸ƒ", hp: 40, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/133.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/133.png" },
        { id: 2, type: "dec_to_min", name: "è€¿é¬¼", hp: 50, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/94.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/94.png" },
        { id: 3, type: "min_to_frac_mcq", name: "è·¯å¡åˆ©æ­", hp: 70, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/448.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/448.png" },
        { id: 4, type: "min_to_dec", name: "çƒˆå’¬é™¸é¯Š", hp: 90, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/445.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/445.png" },
        { id: 5, type: "fill_frac", name: "å™´ç«é¾", hp: 120, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/6.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/6.png" },
        { id: 6, type: "frac_to_min_mcq", name: "é”å…‹èŠä¼Š", hp: 150, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/491.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/491.png" },
        { id: 7, type: "mix_hard", name: "æ´›å¥‡äº", hp: 180, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/249.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/249.png" },
        { id: 8, type: "mix_hard", name: "çƒˆç©ºå", hp: 220, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/384.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/384.png" },
        { id: 9, type: "boss", name: "è¶…å¤¢", hp: 300, 
          imgAnim: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/150.gif", 
          imgArt: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/150.png" }
    ];

    const timeData =[
        { min: 5, frac: {n:1, d:12}, dec: null }, { min: 6, frac: {n:1, d:10}, dec: 0.1 },
        { min: 10, frac: {n:1, d:6}, dec: null }, { min: 12, frac: {n:1, d:5}, dec: 0.2 },
        { min: 15, frac: {n:1, d:4}, dec: 0.25 }, { min: 18, frac: {n:3, d:10}, dec: 0.3 },
        { min: 20, frac: {n:1, d:3}, dec: null }, { min: 24, frac: {n:2, d:5}, dec: 0.4 },
        { min: 25, frac: {n:5, d:12}, dec: null }, { min: 30, frac: {n:1, d:2}, dec: 0.5 },
        { min: 36, frac: {n:3, d:5}, dec: 0.6 }, { min: 40, frac: {n:2, d:3}, dec: null },
        { min: 42, frac: {n:7, d:10}, dec: 0.7 }, { min: 45, frac: {n:3, d:4}, dec: 0.75 },
        { min: 48, frac: {n:4, d:5}, dec: 0.8 }, { min: 50, frac: {n:5, d:6}, dec: null },
        { min: 54, frac: {n:9, d:10}, dec: 0.9 }, { min: 55, frac: {n:11, d:12}, dec: null }
    ];

    let Game = { levelIdx: 0, lives: 3, pMaxHp: 200, pHp: 200, eMaxHp: 60, eHp: 60, energy: 0, seconds: 0, mainTimer: null, qAns: 0, qTimer: null, qTimeLeft: 30, qMaxTime: 30, currentMcqOptions:[], currentExplanation: "", isProcessing: false, paused: false, totalQ: 0, correctQ: 0 };

    /* --- é–‹ç™¼è€…æ¸¬è©¦æŒ‰éˆ• --- */
    function skipToBoss() {
        if(document.getElementById('home-screen').style.display !== 'none') {
            startGame();
        }
        Game.levelIdx = 8;
        loadLevel(8);
    }

    /* --- ä»‹é¢åˆ‡æ›èˆ‡éŠæˆ²å¾ªç’° --- */
    function startGame() {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        
        Game = { levelIdx: 0, lives: 3, pMaxHp: 200, pHp: 200, energy: 0, seconds: 0, isProcessing: false, paused: false, totalQ: 0, correctQ: 0 };
        if(Game.mainTimer) clearInterval(Game.mainTimer);
        Game.mainTimer = setInterval(() => { 
            if (Game.paused) return; 
            Game.seconds++; 
            document.getElementById('game-time').innerText = `${String(Math.floor(Game.seconds/60)).padStart(2,'0')}:${String(Game.seconds%60).padStart(2,'0')}`; 
        }, 1000);
        
        loadLevel(0);
    }

    function returnToHome() {
        document.getElementById('result-overlay').style.display = 'none';
        document.getElementById('pause-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('home-screen').style.display = 'flex';
        if(Game.mainTimer) clearInterval(Game.mainTimer);
        Game.paused = false;
    }

    function togglePause() {
        Game.paused = !Game.paused;
        document.getElementById('pause-screen').style.display = Game.paused ? 'flex' : 'none';
    }

    function showResultScreen(isWin) {
        if(Game.mainTimer) clearInterval(Game.mainTimer);
        
        document.getElementById('result-overlay').style.display = 'flex';
        
        let title = document.getElementById('result-title');
        title.innerText = isWin ? "ğŸ† æ­å–œé€šé—œï¼" : "ğŸ’€ æŒ‘æˆ°å¤±æ•—...";
        title.style.color = isWin ? "#f1c40f" : "#e74c3c";

        document.getElementById('res-time').innerText = document.getElementById('game-time').innerText;
        document.getElementById('res-lives').innerText = "â¤ï¸".repeat(Game.lives) + (Game.lives === 0 ? " (å·²è€—ç›¡)" : "");
        
        let accuracy = Game.totalQ > 0 ? ((Game.correctQ / Game.totalQ) * 100).toFixed(1) : 0;
        document.getElementById('res-accuracy').innerText = `${accuracy}% (${Game.correctQ}/${Game.totalQ}é¡Œ)`;

        // å‹•æ…‹ç”Ÿæˆæˆ°åˆ©å“åœ–ç‰‡ (ä½¿ç”¨å®˜æ–¹ç«‹ç¹ª imgArt)
        let galleryHtml = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png" title="æ¯”å¡è¶…" alt="æ¯”å¡è¶…">`;
        for(let i = 0; i <= Game.levelIdx; i++) {
            if(!isWin && i === Game.levelIdx) break;
            galleryHtml += `<img src="${LEVELS[i].imgArt}" title="${LEVELS[i].name}" alt="${LEVELS[i].name}">`;
        }
        document.getElementById('res-gallery').innerHTML = galleryHtml;
    }

    function loadLevel(idx) {
        Game.levelIdx = idx; let lvl = LEVELS[idx]; Game.eMaxHp = lvl.hp; Game.eHp = lvl.hp;
        document.getElementById('level-id').innerText = lvl.id;
        document.getElementById('enemy-name').innerText = lvl.name; 
        // æˆ°é¬¥ç•«é¢è¼‰å…¥å‹•ç•« (imgAnim)
        document.getElementById('enemy-img').src = lvl.imgAnim;
        msg(`ç¬¬ ${lvl.id} é—œï¼šé‡ç”Ÿ ${lvl.name} å‡ºç¾äº†ï¼`); updateUI();
    }

    function startTurn(type) {
        if(Game.isProcessing) return;
        Game.actionType = type; generateMathQuestion();
        document.getElementById('math-overlay').style.display = 'flex';
        Game.qMaxTime = (Game.levelIdx >= 5) ? 24 : 30; // å¾ŒæœŸç§’æ•¸ç¨çŸ­
        Game.qTimeLeft = Game.qMaxTime; startQuestionTimer();
    }

    /* --- å‹•æ…‹é¡Œåº«ç”Ÿæˆ --- */
    function generateMathQuestion() {
        let type = LEVELS[Game.levelIdx].type;
        if(type === "boss" || type === "mix_hard") {
            const types =["frac_to_min", "dec_to_min", "min_to_frac_mcq", "min_to_dec", "fill_frac", "frac_to_min_mcq"];
            type = types[Math.floor(Math.random() * types.length)];
        }

        let isNumpad = true; let qHtml = ""; let unit = "";
        let td;
        do { td = timeData[Math.floor(Math.random() * timeData.length)]; } 
        while ( (type.includes("dec") && td.dec === null) || (type.includes("frac") && td.frac === null) );

        if (type === "frac_to_min") {
            Game.qAns = td.min; unit = "åˆ†é˜"; qHtml = `${renderFrac(td.frac.n, td.frac.d)} å°æ™‚ = ?`;
            Game.currentExplanation = `1å°æ™‚ = 60åˆ†é˜ã€‚<br>é‡åˆ° ${td.frac.n}/${td.frac.d} å°æ™‚ï¼Œå…ˆç®— 60 Ã· <span class="highlight">${td.frac.d}</span> = ${60/td.frac.d} åˆ†ã€‚<br>å†ä¹˜ä¸Šåˆ†å­ï¼š${60/td.frac.d} Ã— <span class="highlight">${td.frac.n}</span> = <span class="highlight">${td.min}</span> åˆ†é˜å–”ï¼`;
        } 
        else if (type === "dec_to_min") {
            Game.qAns = td.min; unit = "åˆ†é˜"; qHtml = `${td.dec} å°æ™‚ = ?`;
            Game.currentExplanation = `1å°æ™‚ = 60åˆ†é˜ã€‚<br>è¦æŠŠå°æ•¸è½‰æˆæ™‚é–“ï¼Œåªè¦æŠŠå°æ•¸ä¹˜ä¸Š 60 å°±å¯ä»¥å›‰ï¼<br>${td.dec} Ã— 60 = <span class="highlight">${td.min}</span> åˆ†é˜ï¼`;
        }
        else if (type === "min_to_frac_mcq") {
            isNumpad = false; Game.qAns = td.frac; qHtml = `${td.min} åˆ†é˜ = ? å°æ™‚`;
            Game.currentMcqOptions = getFracDistractors(td.frac);
            for(let i=0; i<4; i++) document.getElementById(`mcq-${i}`).innerHTML = renderFrac(Game.currentMcqOptions[i].n, Game.currentMcqOptions[i].d);
            Game.currentExplanation = `${td.min} åˆ†é˜ä»£è¡¨ 60 åˆ†ä¹‹ ${td.min} å°æ™‚ã€‚<br>å¯«æˆåˆ†æ•¸æ˜¯ ${td.min}/60ï¼Œç´„ç°¡å¾Œæœƒè®Šæˆ <span class="highlight">${td.frac.n}/${td.frac.d}</span> å°æ™‚å–”ï¼`;
        }
        else if (type === "min_to_dec") {
            Game.qAns = td.dec; unit = "å°æ™‚"; qHtml = `${td.min} åˆ†é˜ = ? (è«‹å¡«å°æ•¸) å°æ™‚`;
            Game.currentExplanation = `${td.min} åˆ†é˜ = ${td.min}/60 å°æ™‚ã€‚<br>åŒ–ç°¡å¾Œæ˜¯ ${td.frac.n}/${td.frac.d} å°æ™‚ï¼Œæ›ç®—æˆå°æ•¸å°±æ˜¯ <span class="highlight">${td.dec}</span> å°æ™‚ï¼`;
        }
        else if (type === "fill_frac") {
            Game.qAns = td.frac.n; unit = ""; qHtml = `${renderFrac("?", td.frac.d)} å°æ™‚ = ${td.min} åˆ†é˜<br><span style="font-size:18px;color:#ccc;">(è«‹è¼¸å…¥åˆ†å­çš„æ•¸å­—)</span>`;
            Game.currentExplanation = `é€†å‘æ€è€ƒï¼åˆ†æ¯æ˜¯ ${td.frac.d}ã€‚<br>1/${td.frac.d} å°æ™‚ = 60 Ã· ${td.frac.d} = ${60/td.frac.d} åˆ†é˜ã€‚<br>é¡Œç›®æ˜¯ ${td.min} åˆ†é˜ï¼Œæ‰€ä»¥ ${td.min} Ã· ${60/td.frac.d} = <span class="highlight">${td.frac.n}</span>ï¼Œåˆ†å­å°±æ˜¯ ${td.frac.n} å•¦ï¼`;
        }
        else if (type === "frac_to_min_mcq") {
            isNumpad = false; Game.qAns = td.min; qHtml = `${renderFrac(td.frac.n, td.frac.d)} å°æ™‚ = ? åˆ†é˜`;
            Game.currentMcqOptions = getNumDistractors(td.min);
            for(let i=0; i<4; i++) document.getElementById(`mcq-${i}`).innerText = Game.currentMcqOptions[i] + " åˆ†é˜";
            Game.currentExplanation = `1å°æ™‚ = 60åˆ†é˜ã€‚<br>60 Ã· ${td.frac.d} = ${60/td.frac.d}ã€‚<br>${60/td.frac.d} Ã— ${td.frac.n} = <span class="highlight">${td.min}</span> åˆ†é˜å–”ï¼è¦å°å¿ƒä¸è¦è¢«å¹²æ“¾é¸é …é¨™äº†ï¼`;
        }

        document.getElementById('q-text').innerHTML = qHtml;

        if (isNumpad) {
            document.getElementById('numpad-area').style.display = 'grid'; document.getElementById('mcq-area').style.display = 'none';
            document.getElementById('q-input-box').style.display = 'flex';
            document.getElementById('q-input').innerText = ""; document.getElementById('q-unit').innerText = unit;
        } else {
            document.getElementById('numpad-area').style.display = 'none'; document.getElementById('mcq-area').style.display = 'grid';
            document.getElementById('q-input-box').style.display = 'none';
        }
    }

    function renderFrac(n, d) { return `<div class="fraction"><span class="frac-num">${n}</span><span class="frac-den">${d}</span></div>`; }

    function getFracDistractors(correct) {
        let opts =[correct]; let attempts = 0;
        while(opts.length < 4 && attempts < 100) {
            let rnd = timeData[Math.floor(Math.random() * timeData.length)].frac;
            if(rnd && !opts.some(o => o.n === rnd.n && o.d === rnd.d)) opts.push(rnd); attempts++;
        }
        return opts.sort(() => Math.random() - 0.5);
    }
    function getNumDistractors(correctMin) {
        let opts = new Set([correctMin]);
        opts.add(60 - correctMin);
        opts.add(correctMin + 12 > 60 ? Math.abs(correctMin - 12) : correctMin + 12);
        opts.add(correctMin === 45 ? 15 : (correctMin === 12 ? 20 : 30));
        while(opts.size < 4) opts.add(Math.floor(Math.random() * 11 + 1) * 5);
        return Array.from(opts).slice(0,4).sort(() => Math.random() - 0.5);
    }

    function startQuestionTimer() {
        if(Game.qTimer) clearInterval(Game.qTimer);
        let bar = document.getElementById('q-timer-bar');
        Game.qTimer = setInterval(() => {
            if (Game.paused) return; 
            Game.qTimeLeft -= 0.05;
            bar.style.width = (Game.qTimeLeft / Game.qMaxTime) * 100 + "%";
            if(Game.qTimeLeft <= 0) { clearInterval(Game.qTimer); resolveTurn(false); }
        }, 50);
    }

    /* --- é˜²å‘†è¼¸å…¥è™•ç† --- */
    function pressKey(num) {
        let el = document.getElementById('q-input');
        if(num === '.') {
            if(el.innerText.includes('.')) return; 
            if(el.innerText === '') { el.innerText = '0.'; return; }
        }
        if(el.innerText.length < 5) el.innerText += num;
    }
    function pressClear() { document.getElementById('q-input').innerText = ""; }
    function pressOk() {
        let txt = document.getElementById('q-input').innerText;
        if(txt === "" || txt === "0.") return; 
        let val = parseFloat(txt);
        clearInterval(Game.qTimer); resolveTurn(val === Game.qAns);
    }
    function checkMcq(idx) {
        clearInterval(Game.qTimer);
        let ans = Game.currentMcqOptions[idx];
        let isCorrect = (typeof ans === 'object') ? (ans.n === Game.qAns.n && ans.d === Game.qAns.d) : (ans === Game.qAns);
        resolveTurn(isCorrect);
    }

    /* --- æˆ°é¬¥èˆ‡çµç®— --- */
    function resolveTurn(isCorrect) {
        if (Game.isProcessing) return; 
        Game.isProcessing = true; 
        document.getElementById('math-overlay').style.display = 'none';

        Game.totalQ++;
        if (isCorrect) Game.correctQ++;

        if (!isCorrect) {
            document.getElementById('scaffold-overlay').style.display = 'flex';
            document.getElementById('scaffold-text').innerHTML = Game.qTimeLeft <= 0 ? "æ™‚é–“åˆ°äº†ï¼<br><br>" + Game.currentExplanation : "å“å‘€ï¼Œç®—éŒ¯äº†ï¼<br><br>" + Game.currentExplanation;
            return; 
        }

        if (Game.actionType === 'charge') {
            if(Game.energy < 3) Game.energy++; msg("å„²èƒ½æˆåŠŸï¼ç²å¾—èƒ½é‡"); visualEffect('heal-anim', 'player-img');
        } 
        else if (Game.actionType === 'attack') {
            Game.energy--; 
            let dmg = Math.floor(30 + (Game.qTimeLeft * 3)); 
            Game.eHp = Math.max(0, Game.eHp - dmg); 
            msg(`ç²¾æº–ä¸”å¿«é€Ÿï¼é€ æˆäº† ${dmg} é»æš´æ“Šå‚·å®³ï¼`); visualEffect('shake-anim', 'enemy-img');
        }
        else if (Game.actionType === 'heal') {
            let heal = 80; let old = Game.pHp; Game.pHp = Math.min(Game.pMaxHp, Game.pHp + heal);
            msg(`æ™‚é–“å€’æµï¼å›å¾© ${Game.pHp - old} é»é«”åŠ›ï¼`); visualEffect('heal-anim', 'player-img');
        }

        updateUI();
        if (Game.eHp <= 0) setTimeout(levelWin, 1200); else setTimeout(enemyTurn, 1500);
    }

    function closeScaffoldAndContinue() {
        document.getElementById('scaffold-overlay').style.display = 'none';
        setTimeout(enemyTurn, 500);
    }

    function enemyTurn() {
        if (Game.eHp <= 0) return;
        
        let dmg = Math.floor(Math.random() * 10) + 15 + (Game.levelIdx * 5);
        if (Game.levelIdx >= 5) {
            dmg = Math.floor(dmg * 0.7); 
        }

        Game.pHp = Math.max(0, Game.pHp - dmg);
        msg(`${LEVELS[Game.levelIdx].name} ç™¼å‹•æ”»æ“Šï¼å—åˆ° ${dmg} å‚·å®³ã€‚`);
        visualEffect('shake-anim', 'player-img'); 

        if (Game.pHp <= 0) {
            Game.lives--; 
            updateUI(); 
            if (Game.lives > 0) {
                msg("æ¯”å¡è¶…é‹ç”¨äº†å‰©ä¸‹çš„æ™‚é–“ä¹‹åŠ›å¾©æ´»ï¼");
                setTimeout(() => { Game.pHp = Game.pMaxHp; Game.isProcessing = false; updateUI(); visualEffect('heal-anim', 'player-img'); msg("æˆ°é¬¥ç¹¼çºŒï¼"); }, 2000);
            } else {
                setTimeout(() => { showResultScreen(false); }, 1000);
            }
        } else {
            Game.isProcessing = false; 
            updateUI(); 
        }
    }

    function levelWin() {
        if (Game.levelIdx >= 8) {
            showResultScreen(true);
        } else {
            msg(`å‹åˆ©ï¼${LEVELS[Game.levelIdx].name} å€’ä¸‹äº†...`); 
            setTimeout(() => { Game.isProcessing = false; loadLevel(Game.levelIdx + 1); }, 2000);
        }
    }

    function updateUI() {
        let pBar = document.getElementById('player-hp-bar');
        pBar.style.width = (Game.pHp / Game.pMaxHp) * 100 + "%";
        
        let eBar = document.getElementById('enemy-hp-bar');
        eBar.style.width = (Game.eHp / Game.eMaxHp) * 100 + "%";

        for(let i=1; i<=3; i++) {
            let ball = document.getElementById('eb-'+i);
            if(i <= Game.energy) ball.classList.add('active'); else ball.classList.remove('active');
        }
        document.getElementById('player-lives').innerText = "â¤ï¸".repeat(Game.lives);
        
        document.getElementById('btn-attack').disabled = (Game.energy <= 0 || Game.isProcessing);
        document.getElementById('btn-charge').disabled = Game.isProcessing;
        document.getElementById('btn-heal').disabled = Game.isProcessing;
    }

    function msg(txt) { document.getElementById('message-display').innerText = txt; }
    function visualEffect(cls, id) { let el = document.getElementById(id); el.classList.add(cls); setTimeout(() => el.classList.remove(cls), 800); }

</script>
</body>
</html>
