<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>應用題列式速算</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .feedback-correct {
            color: #22c55e; /* green-500 */
        }
        .feedback-incorrect {
            color: #ef4444; /* red-500 */
        }
        .feedback-hint {
            color: #f97316; /* orange-500 */
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #game-container {
            background-color: #ffffff;
            background-image: radial-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 25px 25px;
            position: relative; /* For positioning the score counter */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-100 to-blue-200 flex items-center justify-center min-h-screen p-2 sm:p-4">
    <div id="game-container" class="w-full max-w-2xl mx-auto rounded-2xl shadow-xl p-4 sm:p-6 md:p-10 text-center">
        
        <!-- 完成題目計數器 -->
        <div id="score-counter" class="absolute top-4 right-4 sm:top-6 sm:right-6 bg-blue-100 text-blue-800 text-sm sm:text-base font-bold px-3 py-1 rounded-full">
            完成題目：<span id="completed-count">0</span>
        </div>

        <!-- 標題 -->
        <header class="mb-4 md:mb-6">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800">應用題列式速算</h1>
            <p class="text-sm sm:text-base text-gray-500 mt-2">一步一步來，先判斷，再選擇算式！</p>
        </header>

        <!-- 案卷區 (題目) -->
        <div id="case-file" class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg mb-4 md:mb-6 min-h-[120px] flex items-center justify-center">
            <p id="problem-text" class="text-lg sm:text-xl md:text-2xl font-semibold leading-relaxed"></p>
        </div>
        
        <!-- 回饋訊息區 -->
        <div id="feedback-area" class="min-h-[120px] flex items-center justify-center mb-4 md:mb-6 px-2 sm:px-4">
            <p id="feedback-text" class="text-base sm:text-lg font-bold transition-opacity duration-300 opacity-100 text-left leading-relaxed"></p>
        </div>

        <!-- 步驟一：判斷增減 -->
        <div id="step1-buttons" class="grid grid-cols-1 gap-4">
            <p id="step1-prompt" class="text-gray-600 font-bold mb-2">步驟一：問句主角的數量較多還是較少？</p>
            <button data-choice="more" class="step1-btn w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 sm:py-4 px-6 rounded-lg text-lg md:text-xl transition-transform transform hover:scale-105 active:scale-95">
                <span class="protagonist-name-display"></span>
                <span>（問句主角）的數量較多</span>
            </button>
            <button data-choice="less" class="step1-btn w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 sm:py-4 px-6 rounded-lg text-lg md:text-xl transition-transform transform hover:scale-105 active:scale-95">
                <span class="protagonist-name-display"></span>
                <span>（問句主角）的數量較少</span>
            </button>
        </div>
        
        <!-- 步驟二：選擇算法 -->
        <div id="step2-buttons" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
            <p id="step2-prompt" class="text-gray-600 font-bold mb-2 col-span-1 md:col-span-3 text-lg md:text-xl"></p>
            <button data-choice="option1" class="step2-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-xl md:text-2xl transition-transform transform hover:scale-105 active:scale-95"></button>
            <button data-choice="option2" class="step2-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-xl md:text-2xl transition-transform transform hover:scale-105 active:scale-95"></button>
            <button data-choice="option3" class="step2-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-xl md:text-2xl transition-transform transform hover:scale-105 active:scale-95"></button>
        </div>
        
        <!-- 下一題按鈕 -->
        <div id="next-button-container" class="mt-6 h-16">
           <button id="next-btn" class="hidden w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-10 rounded-lg text-xl transition-all active:scale-95">
                下一題
            </button>
        </div>
    </div>

    <script>
        const problemTextEl = document.getElementById('problem-text');
        const feedbackTextEl = document.getElementById('feedback-text');
        const step1Buttons = document.getElementById('step1-buttons');
        const step1Prompt = document.getElementById('step1-prompt');
        const step2Buttons = document.getElementById('step2-buttons');
        const step2Prompt = document.getElementById('step2-prompt');
        const nextBtn = document.getElementById('next-btn');
        const protagonistNameDisplays = document.querySelectorAll('.protagonist-name-display');
        const completedCountEl = document.getElementById('completed-count');

        let completedCount = 0;

        const items = [
            { name: '蘋果', unit: '個' },
            { name: '糖果', unit: '粒' },
            { name: '貼紙', unit: '張' },
            { name: '鉛筆', unit: '枝' },
            { name: '書', unit: '本' },
            { name: '波子', unit: '粒' },
            { name: '西瓜', unit: '個' },
            { name: '橙', unit: '個' }
        ];

        const problemTemplates = [
            { p: (s1, s2, n1, n2, item) => `${s1}有${n1}${item.unit}${item.name}，${s1}比${s2}多${n2}${item.unit}。請問${s2}有多少${item.unit}${item.name}？`, ans1: 'less', compare_subj: 's1', compare_word: '多' },
            { p: (s1, s2, n1, n2, item) => `${s1}有${n1}${item.unit}${item.name}，${s2}比${s1}多${n2}${item.unit}。請問${s2}有多少${item.unit}${item.name}？`, ans1: 'more', compare_subj: 's2', compare_word: '多' },
            { p: (s1, s2, n1, n2, item) => `${s1}有${n1}${item.unit}${item.name}，${s1}比${s2}少${n2}${item.unit}。請問${s2}有多少${item.unit}${item.name}？`, ans1: 'more', compare_subj: 's1', compare_word: '少' },
            { p: (s1, s2, n1, n2, item) => `${s1}有${n1}${item.unit}${item.name}，${s2}比${s1}少${n2}${item.unit}。請問${s2}有多少${item.unit}${item.name}？`, ans1: 'less', compare_subj: 's2', compare_word: '少' },
            { p: (s1, s2, n1, n2, item) => `停車場有${n1}輛汽車，比電單車多${n2}輛。請問電單車有多少輛？`, ans1: 'less', compare_subj: '汽車', compare_word: '多' },
            { p: (s1, s2, n1, n2, item) => `紅色盒子有${n1}${item.unit}${item.name}，比藍色盒子的少${n2}${item.unit}。請問藍色盒子有多少${item.unit}${item.name}？`, ans1: 'more', compare_subj: '紅色盒子', compare_word: '少' },
        ];

        let currentProblem = {};

        function generateQuestion() {
            const templateIndex = Math.floor(Math.random() * problemTemplates.length);
            const templateData = problemTemplates[templateIndex];

            const people = ['小明', '小華', '小麗', '大文', '老師'].sort(() => 0.5 - Math.random());
            const selectedItem = items[Math.floor(Math.random() * items.length)];
            
            const personA = people[0];
            const personB = people[1];
            
            const baseNumber = (Math.floor(Math.random() * 8) + 2) * 10; // 20-90
            const diffNumber = (Math.floor(Math.random() * (baseNumber / 10 - 1)) + 1) * 10; // 10 up to base-10

            let problemString = templateData.p(personA, personB, baseNumber, diffNumber, selectedItem);
            
            let questionProtagonist;
            const questionMatch = problemString.match(/請問([^有多少]+)有多少/);
            if (questionMatch) {
                questionProtagonist = questionMatch[1];
            }

            let compareSubjectName = '';
            if (templateData.compare_subj === 's1') {
                compareSubjectName = personA;
            } else if (templateData.compare_subj === 's2') {
                compareSubjectName = personB;
            } else {
                compareSubjectName = templateData.compare_subj;
            }

            // 為人物名稱加上專名號 (底線)
            people.forEach(p => {
                 problemString = problemString.replace(new RegExp(p, 'g'), `<u>${p}</u>`);
            });

            // 格式化問句主角 (粗體)
            const protagonistRegex = new RegExp(questionProtagonist.replace(/(\(|\))/g, '\\$1'), 'g');
            problemString = problemString.replace(/(請問)([^有多]+)(有多少.*)/, (match, p1, p2, p3) => {
                let formattedProtagonist = p2;
                if(people.includes(p2)) {
                    formattedProtagonist = `<u>${p2}</u>`;
                }
                return `${p1}<strong>${formattedProtagonist}</strong>${p3}`;
            });

            problemTextEl.innerHTML = problemString;
            
            currentProblem = {
                protagonist: questionProtagonist,
                correctAnswerStep1: templateData.ans1,
                num1: baseNumber,
                num2: diffNumber,
                compareSubjectName: compareSubjectName,
                compareWord: templateData.compare_word
            };
            
            protagonistNameDisplays.forEach(el => {
                el.innerHTML = `<u>${currentProblem.protagonist}</u>`;
            });
        }

        function handleStep1Choice(playerChoice) {
            if (playerChoice === currentProblem.correctAnswerStep1) {
                feedbackTextEl.className = 'feedback-correct text-xl font-bold text-center';
                feedbackTextEl.innerHTML = `答對了！你成功判斷出主角 <strong><u>${currentProblem.protagonist}</u></strong> 的數量會變${playerChoice === 'more' ? '多' : '少'}。`;
                
                setTimeout(() => {
                    step1Buttons.classList.add('hidden');
                    setupStep2();
                    step2Buttons.classList.remove('hidden');
                }, 2000);

            } else {
                feedbackTextEl.className = 'feedback-incorrect text-xl font-bold text-left';
                feedbackTextEl.innerHTML = `不對哦，讓我們一起想一想：<br>
                1. 「比」前面的主角是誰？ <strong><u>${currentProblem.compareSubjectName}</u></strong>。<br>
                2. 他的數量是較**${currentProblem.compareWord}**。<br>
                3. 那麼，問題主角 <strong><u>${currentProblem.protagonist}</u></strong> 的數量是較多還是較少呢？`;
            }
        }
        
        function setupStep2(){
            const {protagonist, correctAnswerStep1, num1, num2} = currentProblem;
            
            step2Prompt.innerHTML = `<u>${protagonist}</u> 的數量較${correctAnswerStep1 === 'more' ? '多' : '少'}，應該用哪一種算式？`;
            
            let correctFormula, wrongFormula1, wrongFormula2;
            if (correctAnswerStep1 === 'more') {
                correctFormula = `${num1} + ${num2}`;
                wrongFormula1 = `${num1} - ${num2}`;
            } else { // less
                correctFormula = `${num1} - ${num2}`;
                wrongFormula1 = `${num1} + ${num2}`;
            }
            wrongFormula2 = `${num2} - ${num1}`;
            currentProblem.correctAnswerStep2 = correctFormula;
            
            const options = [correctFormula, wrongFormula1, wrongFormula2].sort(() => Math.random() - 0.5);
            
            const btns = step2Buttons.querySelectorAll('.step2-btn');
            btns.forEach((btn, i) => {
                btn.textContent = options[i];
            });

            feedbackTextEl.className = 'text-gray-800 text-xl font-bold text-center';
            feedbackTextEl.textContent = '請選擇正確的算式！';
        }

        function handleStep2Choice(playerChoiceText) {
            if (playerChoiceText === currentProblem.correctAnswerStep2) {
                feedbackTextEl.className = 'feedback-correct text-xl font-bold text-center';
                const methodText = currentProblem.correctAnswerStep1 === 'more' ? '加法' : '減法';
                feedbackTextEl.innerHTML = `太棒了！你完成了整道題！<br>數量變${currentProblem.correctAnswerStep1 === 'more' ? '多' : '少'}，所以用**${methodText}**是完全正確的。`;
                
                step2Buttons.querySelectorAll('button').forEach(btn => btn.classList.add('btn-disabled'));
                nextBtn.classList.remove('hidden');
                
                // 更新計數器
                completedCount++;
                completedCountEl.textContent = completedCount;

            } else {
                feedbackTextEl.className = 'feedback-hint text-xl font-bold text-center';
                let hint = '';
                const parts = playerChoiceText.split(' - ');

                if (parts.length === 2 && parseInt(parts[0], 10) < parseInt(parts[1], 10)) {
                    hint = '提示：在減法中，通常會用大的數字減去小的數字！';
                } else {
                    hint = currentProblem.correctAnswerStep1 === 'more' 
                        ? '提示：數量變多了，應該用加法還是減法呢？' 
                        : '提示：數量變少了，應該用加法還是減法呢？';
                }
                feedbackTextEl.textContent = hint;
            }
        }
        
        function resetForNextQuestion() {
            step1Prompt.textContent = '步驟一：問句主角的數量較多還是較少？';
            feedbackTextEl.textContent = '';
            nextBtn.classList.add('hidden');
            
            step2Buttons.classList.add('hidden');
            step1Buttons.classList.remove('hidden');

            step2Buttons.querySelectorAll('button').forEach(btn => btn.classList.remove('btn-disabled'));

            generateQuestion();
        }

        step1Buttons.addEventListener('click', (e) => {
            if (e.target.closest('.step1-btn')) {
                handleStep1Choice(e.target.closest('.step1-btn').dataset.choice);
            }
        });

        step2Buttons.addEventListener('click', (e) => {
            const btn = e.target.closest('.step2-btn');
            if (btn && !btn.classList.contains('btn-disabled')) {
                handleStep2Choice(btn.textContent);
            }
        });
        
        nextBtn.addEventListener('click', resetForNextQuestion);

        window.onload = () => {
            resetForNextQuestion();
        };
    </script>
</body>
</html>
